<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Dashboard - KTP Capture</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #007bff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .participant-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        
        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .participant-name {
            font-weight: bold;
            color: #28a745;
        }
        
        .participant-menu {
            position: relative;
        }
        
        .menu-button {
            background: #3a3a3a;
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-button:hover {
            background: #4a4a4a;
        }
        
        .menu-dropdown {
            position: absolute;
            top: 35px;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 5px;
            padding: 5px 0;
            min-width: 180px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .menu-dropdown.show {
            display: block;
        }
        
        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            color: white;
            font-size: 13px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #007bff;
        }
        
        .video-preview {
            background: #000;
            width: 100%;
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .video-placeholder {
            color: #666;
            font-size: 14px;
            text-align: center;
        }
        
        .capture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .participant-status {
            background: #17a2b8;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }
        
        .status-connecting {
            background: #ffc107;
            color: #000;
        }
        
        .status-online {
            background: #28a745;
        }
        
        .status-capturing {
            background: #fd7e14;
        }
        
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .capture-result {
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .capture-result.show {
            display: block;
        }
        
        .result-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .result-image {
            text-align: center;
        }
        
        .result-image img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #4a4a4a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüíº CS Dashboard - KTP Capture System</h1>
            <p>Kelola capture KTP dari nasabah dengan mode manual (sama seperti app.py)</p>
        </div>
        
        <div class="controls">
            <button onclick="joinRoom()" id="joinBtn">üö™ Join as CS</button>
            <span id="roomStatus">Status: Siap untuk join room</span>
        </div>
        
        <div class="participants-grid" id="participantsGrid">
            <!-- Participant cards akan muncul di sini -->
        </div>
        
        <div class="capture-result" id="captureResult">
            <h3>üì∏ Hasil Capture</h3>
            <div id="resultContent"></div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // Socket.IO connection
        const socket = io();
        
        // Global variables
        let csId = 'CS_' + Math.random().toString(36).substr(2, 9);
        let roomId = 'room_001';
        let participants = new Map();
        let activeOverlays = new Set();
        
        // DOM elements
        const participantsGrid = document.getElementById('participantsGrid');
        const roomStatus = document.getElementById('roomStatus');
        const captureResult = document.getElementById('captureResult');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('CS Dashboard siap. Klik Join untuk mulai monitoring nasabah.');
        });
        
        function joinRoom() {
            console.log('Attempting to join room as CS:', csId);
            
            socket.emit('join_room', {
                room: roomId,
                user_type: 'cs',
                user_id: csId
            });
            
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('joinBtn').textContent = 'Joining...';
            updateStatus('Joining room sebagai CS...');
            
            // Set timeout to re-enable button if join fails
            setTimeout(() => {
                if (document.getElementById('joinBtn').textContent === 'Joining...') {
                    document.getElementById('joinBtn').disabled = false;
                    document.getElementById('joinBtn').textContent = 'üö™ Join as CS';
                    updateStatus('Join timeout. Coba lagi.');
                }
            }, 5000);
        }
        
        function updateStatus(message) {
            roomStatus.textContent = 'Status: ' + message;
            console.log('CS Status:', message);
        }
        
        function createParticipantCard(participantId, userType) {
            if (userType !== 'nasabah') return; // Hanya tampilkan nasabah
            
            const cardId = 'participant_' + participantId;
            
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.id = cardId;
            
            card.innerHTML = `
                <div class="participant-header">
                    <div class="participant-name">üßë‚Äçüíº ${participantId}</div>
                    <div class="participant-menu">
                        <button class="menu-button" onclick="toggleMenu('${participantId}')">‚ãÆ</button>
                        <div class="menu-dropdown" id="menu_${participantId}">
                            <button class="menu-item" onclick="showKTPFrame('${participantId}')">
                                üì± Show KTP Frame
                            </button>
                            <button class="menu-item" onclick="captureKTP('${participantId}')">
                                üì∏ Capture KTP (Manual Mode)
                            </button>
                            <button class="menu-item" onclick="hideKTPFrame('${participantId}')">
                                ‚ùå Hide KTP Frame
                            </button>
                            <button class="menu-item" onclick="resetOverlay('${participantId}')">
                                üîÑ Reset Overlay
                            </button>
                        </div>
                    </div>
                </div>
                <div class="video-preview" id="video_${participantId}">
                    <video id="camera_${participantId}" autoplay muted playsinline style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; display: none;"></video>
                    <canvas class="capture-overlay" id="overlay_${participantId}"></canvas>
                    <div class="video-placeholder" id="placeholder_${participantId}">
                        üìπ Video Nasabah<br>
                        <small>Klik titik tiga untuk aksi capture</small>
                    </div>
                </div>
                <div class="participant-status status-online" id="status_${participantId}">
                    Online - Siap untuk capture
                </div>
            `;
            
            participantsGrid.appendChild(card);
            participants.set(participantId, {
                userType: userType,
                status: 'online'
            });
            
            // Setup camera for nasabah if this is a nasabah participant
            if (userType === 'nasabah') {
                setupCameraForNasabah(participantId);
            }
        }
        
        async function setupCameraForNasabah(participantId) {
            try {
                const video = document.getElementById(`camera_${participantId}`);
                const placeholder = document.getElementById(`placeholder_${participantId}`);
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: false 
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Setup overlay canvas size
                const overlay = document.getElementById(`overlay_${participantId}`);
                overlay.width = 640;
                overlay.height = 480;
                
                console.log(`Camera setup for nasabah ${participantId}`);
                updateStatus(`Kamera aktif untuk nasabah ${participantId}`);
                
            } catch (error) {
                console.error('Error setting up camera:', error);
                updateStatus(`Error mengakses kamera untuk nasabah ${participantId}: ` + error.message);
            }
        }
        
        function removeParticipantCard(participantId) {
            const card = document.getElementById('participant_' + participantId);
            if (card) {
                card.remove();
                participants.delete(participantId);
                activeOverlays.delete(participantId);
            }
        }
        
        function toggleMenu(participantId) {
            // Close all other menus
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                if (menu.id !== 'menu_' + participantId) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById('menu_' + participantId);
            menu.classList.toggle('show');
        }
        
        function showKTPFrame(participantId) {
            socket.emit('show_ktp_frame', {
                cs_id: csId,
                nasabah_id: participantId,
                room: roomId
            });
            
            // Update status
            const status = document.getElementById('status_' + participantId);
            status.textContent = 'KTP Frame Active - Posisikan sesuai guide';
            status.className = 'participant-status status-capturing';
            
            activeOverlays.add(participantId);
            
            // Tampilkan overlay di CS interface juga
            startOverlayForParticipant(participantId);
            
            toggleMenu(participantId); // Close menu
            
            updateStatus(`KTP frame ditampilkan untuk nasabah ${participantId}`);
        }
        
        function hideKTPFrame(participantId) {
            socket.emit('hide_ktp_frame', {
                room: roomId
            });
            
            // Update status
            const status = document.getElementById('status_' + participantId);
            status.textContent = 'Online - Siap untuk capture';
            status.className = 'participant-status status-online';
            
            activeOverlays.delete(participantId);
            
            // Sembunyikan overlay di CS interface
            stopOverlayForParticipant(participantId);
            
            toggleMenu(participantId); // Close menu
            
            updateStatus(`KTP frame disembunyikan untuk nasabah ${participantId}`);
        }
        
        function resetOverlay(participantId) {
            // Stop current overlay if running
            stopOverlayForParticipant(participantId);
            
            // Clear overlay state
            activeOverlays.delete(participantId);
            
            // Update status
            const status = document.getElementById('status_' + participantId);
            status.textContent = 'Online - Siap untuk capture';
            status.className = 'participant-status status-online';
            
            // Send reset to nasabah interface too
            socket.emit('hide_ktp_frame', {
                room: roomId
            });
            
            toggleMenu(participantId); // Close menu
            
            updateStatus(`Overlay direset untuk nasabah ${participantId}`);
        }
        
        function captureKTP(participantId) {
            if (!activeOverlays.has(participantId)) {
                alert('Aktifkan KTP Frame terlebih dahulu!');
                return;
            }
            
            // Update status
            const status = document.getElementById('status_' + participantId);
            status.textContent = 'Processing capture...';
            status.className = 'participant-status status-capturing';
            
            // Get actual frame from camera
            const video = document.getElementById(`camera_${participantId}`);
            if (!video || !video.srcObject) {
                alert('Kamera tidak tersedia untuk nasabah ini!');
                return;
            }
            
            // Create canvas to capture frame
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            
            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Send actual frame data to server
            socket.emit('capture_ktp', {
                cs_id: csId,
                nasabah_id: participantId,
                room: roomId,
                mode: 'manual', // Menggunakan mode manual seperti app.py
                image_data: imageData // Actual frame from CS camera
            });
            
            toggleMenu(participantId); // Close menu
            updateStatus(`Memproses capture KTP untuk nasabah ${participantId}...`);
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.participant-menu')) {
                document.querySelectorAll('.menu-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        // Overlay functions for CS interface
        const overlayIntervals = new Map();
        
        function startOverlayForParticipant(participantId) {
            const canvas = document.getElementById(`overlay_${participantId}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Setup canvas size
            canvas.width = 640;
            canvas.height = 480;
            
            // Start overlay loop
            const interval = setInterval(() => {
                drawKTPOverlay(ctx, canvas.width, canvas.height);
            }, 100);
            
            overlayIntervals.set(participantId, interval);
            console.log(`Overlay started for participant ${participantId}`);
        }
        
        function stopOverlayForParticipant(participantId) {
            const interval = overlayIntervals.get(participantId);
            if (interval) {
                clearInterval(interval);
                overlayIntervals.delete(participantId);
            }
            
            const canvas = document.getElementById(`overlay_${participantId}`);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Force canvas to be completely transparent
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = 'transparent';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Remove from active overlays
            activeOverlays.delete(participantId);
            
            console.log(`Overlay stopped and cleared for participant ${participantId}`);
        }
        
        function drawKTPOverlay(ctx, width, height) {
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Same coordinate calculation as app.py manual mode
            const base_w = 640, base_h = 480;
            const scale_x = width / base_w;
            const scale_y = height / base_h;
            
            const padding_h = parseInt(186 * scale_x);
            const padding_v = parseInt(31 * scale_y);
            const gap = parseInt(25 * scale_y);
            
            const content_width = width - (padding_h * 2);
            const content_height = height - (padding_v * 2);
            
            // Face area (oval)
            const face_w = parseInt(207 * scale_x);
            const face_h = parseInt(223 * scale_y);
            const face_x = padding_h + (content_width - face_w) / 2;
            const face_y = padding_v;
            
            // KTP area (rectangle)
            const ktp_x = padding_h;
            const ktp_y = face_y + face_h + gap;
            const ktp_w = content_width;
            const ktp_h = content_height - face_h - gap;
            
            // Draw overlay background (semi-transparent black)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, width, height);
            
            // Clear face area (oval)
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.ellipse(face_x + face_w/2, face_y + face_h/2, face_w/2, face_h/2, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            // Clear KTP area (rectangle)
            ctx.fillRect(ktp_x, ktp_y, ktp_w, ktp_h);
            
            // Reset composite operation
            ctx.globalCompositeOperation = 'source-over';
            
            // Draw face border (white dashed oval)
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.ellipse(face_x + face_w/2, face_y + face_h/2, face_w/2, face_h/2, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw KTP border (white dashed rectangle)
            ctx.strokeRect(ktp_x, ktp_y, ktp_w, ktp_h);
            
            // Reset line dash
            ctx.setLineDash([]);
        }
        
        // Socket event listeners
        socket.on('connect', function() {
            console.log('Connected to server');
            updateStatus('Terhubung ke server. Siap untuk join room.');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            updateStatus('Terputus dari server. Mencoba reconnect...');
        });
        
        socket.on('participant_joined', function(data) {
            console.log('Participant joined:', data);
            updateStatus(`${data.user_type} ${data.user_id} bergabung ke room`);
            
            if (data.user_type === 'nasabah') {
                createParticipantCard(data.user_id, data.user_type);
                updateStatus(`Nasabah ${data.user_id} terhubung. Siap untuk capture KTP.`);
            } else if (data.user_type === 'cs' && data.user_id === csId) {
                updateStatus('CS berhasil join room. Menunggu nasabah...');
                document.getElementById('joinBtn').textContent = '‚úÖ Joined as CS';
            }
        });
        
        socket.on('participant_left', function(data) {
            console.log('Participant left:', data);
            if (data.user_type === 'nasabah') {
                removeParticipantCard(data.user_id);
                updateStatus(`Nasabah ${data.user_id} keluar dari room`);
            }
        });
        
        socket.on('capture_result', function(data) {
            console.log('Capture result:', data);
            
            // Update participant status
            if (data.nasabah_id) {
                const status = document.getElementById('status_' + data.nasabah_id);
                if (status) {
                    if (data.status === 'success') {
                        status.textContent = 'Capture berhasil!';
                        status.className = 'participant-status status-online';
                        
                        // Automatically hide overlay after successful capture
                        if (activeOverlays.has(data.nasabah_id)) {
                            hideKTPFrame(data.nasabah_id);
                        }
                        
                        // Update button state
                        const captureBtn = document.getElementById('captureBtn_' + data.nasabah_id);
                        if (captureBtn) {
                            captureBtn.textContent = 'üì∏ Capture KTP';
                            captureBtn.disabled = false;
                        }
                    } else {
                        status.textContent = 'Capture gagal: ' + data.message;
                        status.className = 'participant-status status-connecting';
                    }
                }
            }
            
            // Show result
            showCaptureResult(data);
            updateStatus('Capture selesai. Lihat hasil di bawah.');
        });
        
        function showCaptureResult(data) {
            const resultContent = document.getElementById('resultContent');
            
            if (data.status === 'success') {
                resultContent.innerHTML = `
                    <div style="color: #28a745; margin-bottom: 10px;">
                        ‚úÖ <strong>Capture Berhasil!</strong>
                    </div>
                    <div><strong>CS:</strong> ${data.cs_id}</div>
                    <div><strong>Nasabah:</strong> ${data.nasabah_id}</div>
                    <div><strong>Timestamp:</strong> ${data.timestamp}</div>
                    <div><strong>Mode:</strong> Manual (sama seperti app.py)</div>
                    ${data.saved_files ? '<div><strong>Files:</strong> ' + data.saved_files.join(', ') + '</div>' : ''}
                    <div style="margin-top: 15px;">
                        <button onclick="downloadCaptureResults('${data.timestamp}', '${data.cs_id}', '${data.nasabah_id}')" class="btn-success">
                            üì• Download Hasil Capture
                        </button>
                        <button onclick="autoDownloadAll('${data.timestamp}', '${data.cs_id}', '${data.nasabah_id}')" class="btn-success" style="margin-left: 10px;">
                            üì¶ Auto Download All
                        </button>
                    </div>
                `;
                
                // Auto download after 3 seconds
                setTimeout(() => {
                    autoDownloadAll(data.timestamp, data.cs_id, data.nasabah_id);
                    showNotification('‚úÖ Hasil capture telah di-download otomatis!');
                }, 3000);
                
            } else {
                resultContent.innerHTML = `
                    <div style="color: #dc3545; margin-bottom: 10px;">
                        ‚ùå <strong>Capture Gagal!</strong>
                    </div>
                    <div><strong>Error:</strong> ${data.message}</div>
                `;
            }
            
            captureResult.classList.add('show');
            
            // Hide result after 15 seconds (longer for download time)
            setTimeout(() => {
                captureResult.classList.remove('show');
            }, 15000);
        }
        
        function downloadCaptureResults(timestamp, csId, nasabahId) {
            // Download JPG image files
            const baseUrl = '/static/captured_ktp/';
            const files = [
                `cs_${csId}_nasabah_${nasabahId}_face_${timestamp}.jpg`,
                `cs_${csId}_nasabah_${nasabahId}_ktp_${timestamp}.jpg`,
                `cs_${csId}_nasabah_${nasabahId}_full_${timestamp}.jpg`
            ];
            
            files.forEach((filename, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = baseUrl + filename;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, index * 500); // Delay between downloads
            });
            
            showNotification('üì• Download dimulai untuk 3 file JPG hasil capture...');
        }
        
        function autoDownloadAll(timestamp, csId, nasabahId) {
            // Create and download a summary report
            const reportContent = `
=== LAPORAN CAPTURE KTP ===
Timestamp: ${timestamp}
CS ID: ${csId}
Nasabah ID: ${nasabahId}
Mode: Manual (sama seperti app.py)
Status: Berhasil

=== KOORDINAT YANG DIGUNAKAN ===
Base Resolution: 640x480
Padding Horizontal: 186px
Padding Vertical: 31px
Gap: 25px

Face Area:
- Width: 207px
- Height: 223px
- X: 279px (center aligned)
- Y: 31px

KTP Area:
- X: 186px
- Y: 279px
- Width: 268px
- Height: 170px

=== FILES GENERATED ===
1. Face Capture: cs_${csId}_nasabah_${nasabahId}_face_${timestamp}.jpg
2. KTP Capture: cs_${csId}_nasabah_${nasabahId}_ktp_${timestamp}.jpg
3. Full Frame: cs_${csId}_nasabah_${nasabahId}_full_${timestamp}.jpg

=== FILE SPECIFICATIONS ===
- Face Image: 300x300 JPG (Simulated face detection crop)
- KTP Image: 480x300 JPG (Simulated KTP document crop)
- Full Frame: 640x480 JPG (Complete capture with overlay guides)
- All images generated with OpenCV using app.py coordinate logic

=== CATATAN ===
Menggunakan logika koordinat yang sama dengan mode manual di app.py
Capture dilakukan melalui sistem dummy Jitsi Meeting
Tanggal: ${new Date().toLocaleString('id-ID')}
            `;
            
            // Download summary report
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `LAPORAN_CAPTURE_${csId}_${nasabahId}_${timestamp}.txt`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Also download individual files
            setTimeout(() => {
                downloadCaptureResults(timestamp, csId, nasabahId);
            }, 1000);
        }
        
        function showNotification(message) {
            // Create notification if doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px;
                    border-radius: 5px;
                    z-index: 999;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
