<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasabah Interface - Dummy Jitsi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background: #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .video-container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .video-box {
            background: #ffffff;
            width: 100%;
            height: 400px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            border: 2px solid #ddd;
        }
        
        .placeholder-text {
            color: #666;
            font-size: 18px;
            text-align: center;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            background: #17a2b8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffc107;
            color: #000;
            padding: 15px;
            border-radius: 5px;
            z-index: 999;
            display: none;
            max-width: 300px;
        }
        
        .instructions {
            background: #007bff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .instructions.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßë‚Äçüíº Nasabah Interface</h1>
            <p>Interface untuk nasabah saat proses capture KTP</p>
        </div>
        
        <div class="video-container">
            <h3>ÔøΩ Nasabah Display</h3>
            <div class="video-box">
                <div class="placeholder-text">
                    Tampilan Nasabah<br>
                    (CS akan melihat Anda melalui kamera mereka)
                </div>
                <canvas id="overlayCanvas" class="overlay-canvas"></canvas>
            </div>
            <div class="status" id="videoStatus">Siap untuk session</div>
            <div class="instructions" id="instructions">
                <h4>üìã Instruksi KTP Capture (Mode Manual):</h4>
                <ul>
                    <li>Posisikan wajah Anda di dalam <strong>lingkaran putih</strong></li>
                    <li>Tunjukkan KTP di dalam <strong>kotak putih</strong> di bagian bawah</li>
                    <li>Pastikan KTP terlihat jelas dan tidak blur</li>
                    <li>CS akan melakukan capture dari menu titik tiga</li>
                    <li>Menggunakan logika yang sama dengan mode manual di app.py</li>
                </ul>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="joinRoom()" id="joinBtn">üö™ Join Room</button>
        </div>
        
        <div class="status" id="systemStatus">
            Status: Siap untuk memulai
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // Socket.IO connection
        const socket = io();
        
        // Global variables
        let nasabahId = 'NASABAH_' + Math.random().toString(36).substr(2, 9);
        let roomId = 'room_001';
        let overlayActive = false;
        let originalStream = null;
        let processedStream = null;
        
        // DOM elements
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayCtx = overlayCanvas.getContext('2d');
        const systemStatus = document.getElementById('systemStatus');
        const videoStatus = document.getElementById('videoStatus');
        const instructions = document.getElementById('instructions');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Initializing nasabah interface...');
            setupDisplay();
        });
        
        function setupDisplay() {
            // Setup canvas size untuk overlay (standar 640x480)
            overlayCanvas.width = 640;
            overlayCanvas.height = 480;
            
            videoStatus.textContent = 'Display siap';
            updateStatus('Interface siap. Klik Join Room untuk terhubung dengan CS.');
        }
        
        function joinRoom() {
            console.log('Nasabah attempting to join room:', nasabahId);
            
            socket.emit('join_room', {
                room: roomId,
                user_type: 'nasabah',
                user_id: nasabahId
            });
            
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('joinBtn').textContent = 'Joining...';
            updateStatus('Joining room...');
            
            // Set timeout to re-enable button if join fails
            setTimeout(() => {
                if (document.getElementById('joinBtn').textContent === 'Joining...') {
                    document.getElementById('joinBtn').disabled = false;
                    document.getElementById('joinBtn').textContent = 'üö™ Join Room';
                    updateStatus('Join timeout. Coba lagi.');
                }
            }, 5000);
        }
        
        function enableOverlay() {
            overlayActive = true;
            instructions.classList.add('active');
            startOverlayLoop();
            updateStatus('Overlay KTP aktif - Posisikan sesuai panduan');
            showNotification('CS meminta Anda untuk menunjukkan KTP. Posisikan sesuai panduan yang muncul.');
        }
        
        function disableOverlay() {
            overlayActive = false;
            instructions.classList.remove('active');
            clearOverlay();
            updateStatus('Overlay KTP nonaktif');
            showNotification('Capture selesai. Terima kasih!');
        }
        
        function startOverlayLoop() {
            if (!overlayActive) return;
            
            // Clear previous overlay
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Draw KTP overlay (same as app.py)
            drawKTPOverlay();
            
            // Continue loop
            requestAnimationFrame(startOverlayLoop);
        }
        
        function drawKTPOverlay() {
            const w = overlayCanvas.width;
            const h = overlayCanvas.height;
            
            if (w === 0 || h === 0) return;
            
            // Calculate coordinates (same as app.py)
            const base_w = 640, base_h = 480;
            const scale_x = w / base_w;
            const scale_y = h / base_h;
            
            const padding_h = 186 * scale_x;
            const padding_v = 31 * scale_y;
            const gap = 25 * scale_y;
            
            const content_width = w - (padding_h * 2);
            const content_height = h - (padding_v * 2);
            
            // Face area
            const face_w = 207 * scale_x;
            const face_h = 223 * scale_y;
            const face_x = padding_h + (content_width - face_w) / 2;
            const face_y = padding_v;
            
            // KTP area
            const ktp_x = padding_h;
            const ktp_y = face_y + face_h + gap;
            const ktp_w = content_width;
            const ktp_h = content_height - face_h - gap;
            
            // Semi-transparent overlay outside areas
            overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            overlayCtx.fillRect(0, 0, w, h);
            
            // Clear face area (oval)
            overlayCtx.globalCompositeOperation = 'destination-out';
            overlayCtx.beginPath();
            overlayCtx.ellipse(face_x + face_w/2, face_y + face_h/2, face_w/2, face_h/2, 0, 0, 2 * Math.PI);
            overlayCtx.fill();
            
            // Clear KTP area (rectangle)
            overlayCtx.fillRect(ktp_x, ktp_y, ktp_w, ktp_h);
            
            // Reset composite operation
            overlayCtx.globalCompositeOperation = 'source-over';
            
            // Draw guides (white borders)
            overlayCtx.strokeStyle = 'white';
            overlayCtx.lineWidth = 3;
            overlayCtx.setLineDash([10, 5]);
            
            // Face oval border
            overlayCtx.beginPath();
            overlayCtx.ellipse(face_x + face_w/2, face_y + face_h/2, face_w/2, face_h/2, 0, 0, 2 * Math.PI);
            overlayCtx.stroke();
            
            // KTP rectangle border
            overlayCtx.strokeRect(ktp_x, ktp_y, ktp_w, ktp_h);
            
            // Instructions text
            overlayCtx.setLineDash([]);
            overlayCtx.fillStyle = 'yellow';
            overlayCtx.font = 'bold 16px Arial';
            overlayCtx.textAlign = 'center';
            overlayCtx.fillText('Posisikan wajah di lingkaran', w/2, 25);
            overlayCtx.fillText('Tunjukkan KTP di kotak bawah', w/2, h - 15);
        }
        
        function clearOverlay() {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }
        
        function updateStatus(message) {
            systemStatus.textContent = 'Status: ' + message;
            console.log('Status:', message);
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Socket event listeners
        socket.on('connect', function() {
            console.log('Nasabah connected to server');
            updateStatus('Terhubung ke server. Siap untuk join room.');
        });
        
        socket.on('disconnect', function() {
            console.log('Nasabah disconnected from server');
            updateStatus('Terputus dari server. Mencoba reconnect...');
        });
        
        socket.on('participant_joined', function(data) {
            console.log('Participant joined:', data);
            updateStatus(`Participant joined: ${data.user_type} ${data.user_id}`);
            
            if (data.user_type === 'cs') {
                showNotification(`CS ${data.user_id} terhubung. Siap untuk proses KTP capture.`);
                videoStatus.textContent = 'Terhubung dengan CS';
            } else if (data.user_type === 'nasabah' && data.user_id === nasabahId) {
                // This nasabah successfully joined
                document.getElementById('joinBtn').textContent = '‚úÖ Joined Room';
                updateStatus('Berhasil join room. Menunggu instruksi dari CS.');
                videoStatus.textContent = 'Terhubung ke room - Menunggu CS';
            }
        });
        
        socket.on('overlay_command', function(data) {
            console.log('Overlay command:', data);
            
            if (data.action === 'enable') {
                enableOverlay();
            } else if (data.action === 'disable') {
                disableOverlay();
            }
        });
        
        // Resize canvas when video size changes
        window.addEventListener('resize', function() {
            if (video.videoWidth && video.videoHeight) {
                overlayCanvas.width = video.videoWidth;
                overlayCanvas.height = video.videoHeight;
            }
        });
    </script>
</body>
</html>
